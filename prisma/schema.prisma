// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["web_server_webhook", "public"]
}

// Webhook Log - stores raw webhook calls for analysis
model WebhookLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  // Raw webhook data
  rawPayload Json     // complete webhook payload as received
  headers    Json?    // HTTP headers from the request
  method     String   // HTTP method (POST, GET, etc.)
  url        String   // webhook endpoint URL
  
  // Request metadata
  userAgent  String?
  ipAddress  String?
  requestId  String?  // custom request ID if provided
  
  // Processing status
  status     String   @default("received") // received, processed, failed
  errorMessage String?
  
  @@map("webhook_logs")
  @@schema("web_server_webhook")
}

// EvolutionAPI Message table (for thread history)
model Message {
  id        String   @id @default(cuid())
  key       Json     // Contains id, remoteJid, fromMe, participant
  pushName  String?
  status    String?
  message   Json     // Contains conversation, messageContextInfo, etc.
  contextInfo Json?  // Contains stanzaId, participant, quotedMessage
  messageType String?
  messageTimestamp BigInt?
  instanceId String?
  source    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Message")
  @@schema("public")
}

// Configuration - stores message processing configurations
model Configuration {
  id            String   @id @default(cuid())
  name          String   // Human-readable name
  enabled       Boolean  @default(true)
  groupIds      String[] // Array of WhatsApp group IDs to listen to
  processorClass String   // Class name of processor to use
  spreadsheetId String   // Google Sheets ID
  mainSheetName String   // Name of main data sheet
  logSheetName  String   // Name of log sheet
  auditSheetName String   // Name of audit sheet
  columnMapping Json     // Column index mappings (JSONB)
  metadata      Json?    // Additional metadata (JSONB)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  prompts       Prompt[]
  schema        Schema?

  @@map("configurations")
  @@schema("public")
}

// Prompt - stores LLM prompts for configurations
model Prompt {
  id             String   @id @default(cuid())
  configurationId String
  name           String   // Prompt name (e.g., "first_message", "reply_analysis")
  type           String   // Prompt type
  template       String   // Prompt template with variables
  systemPrompt   String?  // Optional system prompt
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  configuration  Configuration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@map("prompts")
  @@schema("public")
}

// Schema - stores JSON schemas for configurations
model Schema {
  id             String   @id @default(cuid())
  configurationId String  @unique
  definition     Json     // JSON Schema definition
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  configuration  Configuration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@map("schemas")
  @@schema("public")
}
